<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AceBlocks JS Sandbox Beta</title>
<style>
  body { font-family: sans-serif; display:flex; margin:0; }
  #blocklyDiv { height: 600px; width: 40%; border:2px solid #000; }
  #gameDiv { width: 60%; height: 600px; border:2px solid #000; background:#88c0ff; display:flex; flex-direction:column; align-items:center; }
  canvas { border:1px solid #000; background:#a0d0ff; margin-top:10px; }
  #runBtn { margin-top:10px; padding:5px 10px; font-size:16px; cursor:pointer; }
</style>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
</head>
<body>

<div id="blocklyDiv"></div>
<div id="gameDiv">
  <button id="runBtn">Run Code</button>
  <canvas id="gameCanvas" width="800" height="550"></canvas>
</div>

<script>
  // ====== 1. Game Engine ======
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  let sprites = [];

  class Sprite {
    constructor(x, y, imageSrc) {
      this.x = x;
      this.y = y;
      this.width = 50;
      this.height = 50;
      this.image = new Image();
      this.image.src = imageSrc;
    }
    draw() { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
    move(dx, dy) { this.x += dx; this.y += dy; }
  }

  function createSprite(x, y, src) {
    const s = new Sprite(x, y, src);
    sprites.push(s);
    return s;
  }

  function gameLoop() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    sprites.forEach(s=>s.draw());
    requestAnimationFrame(gameLoop);
  }
  gameLoop();

  // ====== 2. Blockly Setup ======
  const workspace = Blockly.inject('blocklyDiv', {
    toolbox: `
      <xml xmlns="https://developers.google.com/blockly/xml">
        <block type="create_sprite"></block>
        <block type="move_sprite"></block>
      </xml>
    `,
    scrollbars:true
  });

  // ----- Custom Blocks -----
  Blockly.Blocks['create_sprite'] = {
    init: function() {
      this.appendDummyInput()
          .appendField("create sprite at x")
          .appendField(new Blockly.FieldNumber(0),"X")
          .appendField("y")
          .appendField(new Blockly.FieldNumber(0),"Y")
          .appendField("image URL")
          .appendField(new Blockly.FieldTextInput("https://i.imgur.com/4ai0FfE.png"),"SRC");
      this.setPreviousStatement(true,null);
      this.setNextStatement(true,null);
      this.setColour(230);
    }
  };

  Blockly.JavaScript['create_sprite'] = function(block){
    const x = block.getFieldValue('X');
    const y = block.getFieldValue('Y');
    const src = block.getFieldValue('SRC');
    return `createSprite(${x},${y},"${src}");\n`;
  };

  Blockly.Blocks['move_sprite'] = {
    init: function() {
      this.appendDummyInput()
          .appendField("move sprite index")
          .appendField(new Blockly.FieldNumber(0),"INDEX")
          .appendField("dx")
          .appendField(new Blockly.FieldNumber(0),"DX")
          .appendField("dy")
          .appendField(new Blockly.FieldNumber(0),"DY");
      this.setPreviousStatement(true,null);
      this.setNextStatement(true,null);
      this.setColour(120);
    }
  };

  Blockly.JavaScript['move_sprite'] = function(block){
    const i = block.getFieldValue('INDEX');
    const dx = block.getFieldValue('DX');
    const dy = block.getFieldValue('DY');
    return `if(sprites[${i}]) sprites[${i}].move(${dx},${dy});\n`;
  };

  // ====== 3. Run Button ======
  document.getElementById('runBtn').addEventListener('click', ()=>{
    const code = Blockly.JavaScript.workspaceToCode(workspace);
    try { eval(code); }
    catch(e){ alert("Error in block code: "+e); console.error(e); }
  });

  // ====== 4. Example Sprites ======
  createSprite(100,100,'https://i.imgur.com/4ai0FfE.png');
  createSprite(300,300,'https://i.imgur.com/9I8c3aZ.png');
</script>
</body>
</html>
