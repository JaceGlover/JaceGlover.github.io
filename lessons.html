// =======================
// BLOCK LIBRARY
// =======================

const blockLibrary = {
  WalkSpeed: { label:"Set WalkSpeed", code:"player.WalkSpeed = 20" },
  JumpPower: { label:"Set JumpPower", code:"player.JumpPower = 60" },
  PlayerAdded: { label:"On Player Join", code:"game.Players.PlayerAdded:Connect(function(player)\nend)" },
  ScreenGui: { label:"Create GUI", code:"local gui = Instance.new('ScreenGui')" },
  TextLabel: { label:"Add TextLabel", code:"local label = Instance.new('TextLabel')" },
  Variable: { label:"Create Variable", code:"local myVar = 10" }
};

// =======================
// LESSONS
// =======================

const lessons = [
{
  objective:"Make the player faster.",
  availableBlocks:["WalkSpeed"],
  requiredBlocks:["WalkSpeed"]
},
{
  objective:"Make the player faster and jump higher.",
  availableBlocks:["WalkSpeed","JumpPower"],
  requiredBlocks:["WalkSpeed","JumpPower"]
},
{
  objective:"Create a GUI and add text.",
  availableBlocks:["ScreenGui","TextLabel"],
  requiredBlocks:["ScreenGui","TextLabel"]
}
];

let currentLesson = 0;

const panel = document.getElementById("panel");
const objective = document.getElementById("objective");
const blocksArea = document.getElementById("blocksArea");
const output = document.getElementById("output");

// =======================
// LOAD LESSON
// =======================

function loadLesson() {
  panel.innerHTML = "";
  blocksArea.innerHTML = "";
  output.textContent = "";

  const lesson = lessons[currentLesson];
  objective.textContent = "Lesson " + (currentLesson+1) + ": " + lesson.objective;

  lesson.availableBlocks.forEach(key => {
    const block = document.createElement("div");
    block.className = "block";
    block.textContent = blockLibrary[key].label;
    block.draggable = true;
    block.dataset.key = key;

    block.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("panel-block", key);
    });

    panel.appendChild(block);
  });
}

// =======================
// DRAG FROM PANEL
// =======================

blocksArea.addEventListener("dragover", e => {
  e.preventDefault();
});

blocksArea.addEventListener("drop", e => {
  e.preventDefault();

  const key = e.dataTransfer.getData("panel-block");
  if(!key) return;

  createWorkspaceBlock(key);
});

// =======================
// CREATE WORKSPACE BLOCK
// =======================

function createWorkspaceBlock(key){
  const newBlock = document.createElement("div");
  newBlock.className = "workspace-block";
  newBlock.draggable = true;
  newBlock.dataset.key = key;

  newBlock.innerHTML = `
    <span>${blockLibrary[key].code}</span>
    <button class="delete">√ó</button>
  `;

  newBlock.querySelector(".delete").onclick = ()=>newBlock.remove();

  // DRAG REORDER
  newBlock.addEventListener("dragstart", ()=>{
    newBlock.classList.add("dragging");
  });

  newBlock.addEventListener("dragend", ()=>{
    newBlock.classList.remove("dragging");
  });

  blocksArea.appendChild(newBlock);
}

// =======================
// REORDER LOGIC
// =======================

blocksArea.addEventListener("dragover", e=>{
  e.preventDefault();
  const dragging = document.querySelector(".dragging");
  if(!dragging) return;

  const afterElement = getDragAfterElement(blocksArea, e.clientY);
  if(afterElement == null){
    blocksArea.appendChild(dragging);
  } else {
    blocksArea.insertBefore(dragging, afterElement);
  }
});

function getDragAfterElement(container, y) {
  const elements = [...container.querySelectorAll(".workspace-block:not(.dragging)")];

  return elements.reduce((closest, child)=>{
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if(offset < 0 && offset > closest.offset){
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// =======================
// RUN CHECK
// =======================

function runCode(){
  const placed = [...blocksArea.querySelectorAll(".workspace-block")]
    .map(b => b.dataset.key);

  const required = lessons[currentLesson].requiredBlocks;

  const success = required.every(r => placed.includes(r));

  if(success){
    output.textContent = "‚úÖ Lesson Complete!";
  } else {
    output.textContent = "‚ùå Missing required blocks.";
  }
}

function nextLesson(){
  if(currentLesson < lessons.length-1){
    currentLesson++;
    loadLesson();
  } else {
    objective.textContent = "üéâ Course Complete!";
    panel.innerHTML = "";
    blocksArea.innerHTML = "";
    output.textContent = "You finished!";
  }
}

loadLesson();
